@inherits Microsoft.AspNetCore.Mvc.Razor.RazorPage<dynamic>
@{
    // Culture for formatting
    var culture = new System.Globalization.CultureInfo("he-IL");
    DateTime DefDate = Convert.ToDateTime("1/1/1900");
    // Retrieve inputs from ViewData
    var nick_name = (string)ViewData["nick_name"];
    var wanum = (string)ViewData["wanum"];
    var menu_id = (int)ViewData["menu_id"];
    var address = (string)ViewData["address"];
    var city = (string)ViewData["city"];
    var order_body = (string)ViewData["order_body"];
    var donation = (int)ViewData["donation"];
    var orderpw = (string)ViewData["orderpw"];
    var menu_title = (string)ViewData["menu_title"];
    var is_pickup = (bool)(ViewData["is_pickup"] ?? false);
    var is_express = (bool)(ViewData["is_express"] ?? false);
    var is_new_member = (bool)(ViewData["is_new_member"] ?? false);
    var full_name = (string)(ViewData["full_name"] ?? string.Empty);
    var email = (string)(ViewData["email"] ?? string.Empty);
    var ref_source = (string)(ViewData["ref_source"] ?? string.Empty);
    var ref_source_desc = (string)(ViewData["ref_source_desc"] ?? string.Empty);
    var ref_source_other = (string)(ViewData["ref_source_other"] ?? string.Empty);
    var birth_date = (DateTime?)(ViewData["birth_date"]) ?? DefDate;
    var is_ship_phone = (bool)(ViewData["is_ship_phone"] ?? false);
    var ship_name = (string)(ViewData["ship_name"] ?? string.Empty);
    var ship_phone = (string)(ViewData["ship_phone"] ?? string.Empty);
    var is_postponed = (bool)(ViewData["is_postponed"] ?? false);
    var shipping_date = (DateTime?)(ViewData["shipping_date"]) ?? DefDate;
    var shipping_time = (string)(ViewData["shipping_time"] ?? string.Empty);

    // Determine display name for member
    var member_name = is_new_member ? full_name : nick_name;
    var fname = string.Empty;
    if (is_new_member)
    {
        var names = member_name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (names.Length > 0) fname = names[0];
        // new members cannot ship to others
        is_ship_phone = false;
        ship_name = string.Empty;
        ship_phone = string.Empty;
    }
}

<section class="wel_sec">
    <div class="container">
        <div class="form_wel" style="margin-top:25px;">
            <div class="welsc caption">
                <h1>הכל<strong>תקין?</strong></h1>
            </div>
            <div style="overflow: auto; background-color: #dfffbd; border-radius: 5px;padding:5px;margin:5px;">
                ☝️ נא לוודא את נכונותם של פרטי ההזמנה
            </div>

            <div class="box_details" style="background-color: #ffffff; max-width: 350px; padding-bottom: 15px; ">
                <form id="PlaceOrderForm">
                    @* Hidden fields *@
                    <input type="hidden" name="lang" value="he" />
                    <input type="hidden" name="nick_name" value="@nick_name" />
                    <input type="hidden" name="wanum" value="@wanum" />
                    <input type="hidden" name="menu_id" value="@menu_id" />
                    <input type="hidden" name="address" value="@address" />
                    <input type="hidden" name="city" value="@city" />
                    <input type="hidden" name="order_body" value="@order_body" />
                    <input type="hidden" name="donation" value="@donation" />
                    <input type="hidden" name="orderpw" value="@orderpw" />
                    <input type="hidden" name="menu_title" value="@menu_title" />
                    @if (is_new_member)
                    {
                        <input type="hidden" name="is_new_member" value="true" />
                    }
                    <input type="hidden" name="full_name" value="@full_name" />
                    <input type="hidden" name="email" value="@email" />
                    <input type="hidden" name="ref_source" value="@ref_source" />
                    <input type="hidden" name="ref_source_desc" value="@ref_source_desc" />
                    <input type="hidden" name="ref_source_other" value="@ref_source_other" />
                    <input type="hidden" name="birth_date" value="@birth_date.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="is_ship_phone" value="@is_ship_phone" />
                    <input type="hidden" name="ship_name" value="@ship_name" />
                    <input type="hidden" name="ship_phone" value="@ship_phone" />
                    @if (is_postponed)
                    {
                        <input type="hidden" name="is_postponed" value="true" />
                    }
                    <input type="hidden" name="shipping_date" value="@shipping_date.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="shipping_time" value="@shipping_time" />
                </form>

                <div class="infLabel">
                    <div class="infLabelTitle">ההזמנה שלך</div>
                    <div style="overflow:auto; font-size:22px;">@order_body</div>
                </div>

                @* Recipient info *@
                @if (!is_ship_phone)
                {
                    <div class="infLabel">
                        <div class="infLabelTitle">מקבל.ת ההזמנה</div>
                        <div style="overflow:auto; font-size:22px;">
                            @member_name<br />
                            @if (!is_pickup)
                            {
                                @address  @city

                                <br />
                            }
                            @wanum
                        </div>
                    </div>
                }
                else
                {
                    <div class="infLabel">
                        <div class="infLabelTitle">הזמנה על שם</div>
                        <div style="overflow:auto; font-size:22px;">
                            @member_name<br />@wanum
                        </div>
                    </div>
                    <div class="infLabel">
                        <div class="infLabelTitle">מקבל.ת המשלוח</div>
                        <div style="overflow:auto; font-size:22px;">
                            @ship_name<br />@ship_phone
                            @if (!is_pickup)
                            {
                                <br />

                                @address  @city

                                <br />
                            }
                        </div>
                    </div>
                }

                @* Delivery method *@
                <div class="infLabel">
                    <div class="infLabelTitle">אופן אספקה</div>
                    <div style="overflow:auto; font-size:22px;">
                        @if (is_postponed)
                        {
                            <div>משלוח בתאריך @shipping_date.ToString("d", culture)</div>
                        <br />
                            <div>בשעה @shipping_time</div>
                                    }
                        else
                        {
                            <div>@menu_title</div>
                            
                        }
                    </div>
                </div>

                <div class="infLabel">
                    <div class="infLabelTitle">תרומה לקופת הקהילה</div>
                    <div style="overflow:auto;">
                        @(donation > 0 ? donation.ToString("C", culture) : "ללא תרומה לקופה")
                    </div>
                </div>

                @* New vs existing member fields *@
                @if (!is_new_member)
                {
                    <div class="infLabel">
                        <div class="infLabelTitle">סיסמת הזמנות יומית</div>
                        <div style="overflow:auto;">@orderpw</div>
                    </div>
                }
                else
                {
                    <div class="infLabel">
                        <div class="infLabelTitle">כתובת מייל</div>
                        <div style="overflow:auto;">@email</div>
                    </div>
                    <div class="infLabel">
                        <div class="infLabelTitle">תאריך לידה</div>
                        <div style="overflow:auto;">@birth_date.ToString("d", culture)</div>
                    </div>
                    @if (!string.IsNullOrEmpty(ref_source_desc) || !string.IsNullOrEmpty(ref_source_other))
                    {
                        <div class="infLabel">
                            <div class="infLabelTitle">מקור הפניה</div>
                            <div style="overflow:auto;">@(ref_source_other + ref_source_desc)</div>
                        </div>
                    }
                    <div style="overflow:auto; background-color:#dfffbd;">
                        <h3>💚 שלום @fname, אנחנו מאד שמחים שהצטרפת אלינו</h3>
                        <p>מאחר וזו ההזמנה הראשונה שלך, אחד מאנשי הצוות שלנו יצור איתך קשר לאחר השלמת ההזמנה ויסייע לך להתמצא במערכת.</p>
                    </div>
                }

                <div id="OrderActions" style="overflow:auto;">
                    <div class="errBox" id="OrderValidationError"></div>
                    <div class="b_d">
                        <button type="button" class="re" onclick="ControlButton();">עריכה</button>
                        <button type="button" class="sub" onclick="hideElement('OrderActions'); showElement('OrderLoader'); AjaxActions('PlaceOrder', '', '', 'PlaceOrderForm');">אישור!</button>
                    </div>
                </div>
                <center>
                    <div id="OrderLoader" class="spinner" style="font-size:20px; display:none;">
                        <div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div>
                    </div>
                </center>
            </div>
        </div>
        <div class="form_ft_top">
            <div class="container">
                <div class="s_right"><a href="/Main"><img src="/images/ftlogo.png" alt="Hamachteret" /></a></div>
                <div class="s_left">
                    <ul>
                        <li><a href="#"><img src="/images/instagram.png" alt="instagram" /></a></li>
                        <li><a href="#"><img src="/images/facebook.png" alt="facebook" /></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>
