

@using System
@using System.Data.SqlClient
@using Dapper
@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.Configuration
@using Faysal.Helpers
@inject IConfiguration Configuration
@inject IHttpContextAccessor HttpContextAccessor

@{
    // Shared layout for members
    Layout = null;
    var context = HttpContextAccessor.HttpContext;
    var Request = context.Request;
    var Response = context.Response;
    var culture = new System.Globalization.CultureInfo("he-IL");

    DateTime defDate = Convert.ToDateTime("1/1/1900");
    // Helper to read form or query values
    string Param(string key) =>
        HttpContextAccessor.HttpContext.Request.HasFormContentType && HttpContextAccessor.HttpContext.Request.Form.ContainsKey(key)
            ? HttpContextAccessor.HttpContext.Request.Form[key].ToString()
            : HttpContextAccessor.HttpContext.Request.Query[key].ToString();

    // Read inputs

    int order_id = 0; try { order_id = Convert.ToInt32(Param("p2")); } catch { }
    var db = Database.Open("faysal");
    var sqlSelect = "";

    sqlSelect="SELECT * FROM ordertracking WHERE order_id=@0";
    var order = db.QuerySingle(sqlSelect, order_id);


    //  var lang = Param("lang");
    string wanum = order.wanum; 
    string address = ""; address = order.address;
    string city = ""; city = order.city;
    int address_id = 0; try { address_id = order.address_id; } catch { }
    string ship_phone = order.ship_phone;
    string ship_name = order.ship_name;
    string ship_notes =  order.ship_notes;
    string order_notes = order.order_notes;
    string address_nick = "";
    string member_nick = "";
    string disp_address = "";


    decimal order_total = 0;
    decimal order_total_including_shipping = 0;
    decimal shipping_charge = 0;
    decimal free_shipping_marker = 0;
    decimal free_shipping_deficit = 0;
    decimal default_shipping_charge = 0;
    decimal cart_shipping_charge = 0;

    if (address_id > 0)
    {
        sqlSelect="SELECT * FROM Addresses WHERE id=@0";
        var addr = db.QuerySingle(sqlSelect, address_id);
        if(addr!= null)
        {
            address_nick = addr.address_nick;
            disp_address = addr.disp_address;
            ship_notes = addr.address_notes;
        }
        
    }


    ViewData["callingPage"] = "ORDERINFO";
    ViewData["order_id"] = order_id;

    <section class="wel_sec">
        <div class="container">
            <div class="B">
                <div class="A">
                    <img class="ordersLogo" src="/images/s_logo.png" />
                    <div class="B" style="float:left">

                        <div class="ordersSmallButtons" style="float:left">
                            <img src="images/call.png" class="ordersSmallButtons" />
                        </div>
                    </div>

                </div>
                <div class="A">
                    <form id="ReviewOrderForm">

                        <div class="B" style="text-align:center;">
                            <div class="OrderIntroMsg" style="text-align:center;">
                                הזמנה #@order.order_id
                                <div class="OrderIntroSubMsg" style="font-size:14px;">
                                    @order.ts.ToShortDateString() - @order.ts.ToString("HH:mm")

                                </div>

                            </div>

                        </div>
                        <center>

                            <div class="B">
                                @await Html.PartialAsync("Shared/Partials/_CheckoutItems")
                            </div>

                            <div class="shippingInfoReview">
                                <div class="B" style="text-align:right">
                                    <h3>הנמענ.ת</h3>

                                </div>
                                <div class="B" style="text-align:right">
                                    <div class="OrderReviewAddressItem">
                                        @ship_name
                                    </div>
                                    <div class="OrderReviewSubAddress">
                                        @ship_phone
                                    </div>
                                    <div class="Spacer10"></div>
                                    <h3>הכתובת</h3>
                                    @if (!string.IsNullOrEmpty(address_nick))
                                    {
                                        <div class="OrderReviewAddressItem">
                                            <b>@address_nick</b>
                                        </div>
                                        <div class="OrderReviewSubAddress">(@disp_address)</div>
                                    }

                                    @if (address_id == -1)
                                    {
                                        <div class="OrderReviewAddressItem">
                                            @address @city
                                        </div>
                                     
                                 
                                    }





                                </div>

                                @if (!string.IsNullOrEmpty(ship_notes) )
                                {
                                    <div class="Spacer10"></div>
                                    <div class="B" style="text-align:right">
                                        <h3>הערות לכתובת</h3>

                                    </div>
                                    <div class="B" style="text-align:right">
                                        <div class="OrderReviewSubAddress">
                                            @ship_notes
                                        </div>


                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(order_notes))
                                {
                                    <div class="Spacer10"></div>
                                    <div class="B" style="text-align:right">
                                        <h3>הערות להזמנה</h3>

                                    </div>
                                    <div class="B" style="text-align:right">
                                        <div class="OrderReviewSubAddress">
                                            @order_notes
                                        </div>


                                    </div>
                                }

                            </div>

                            <div class="B" style="text-align:center;">
                                <div class="Spacer20"></div>
                                <div class="Spacer5"></div>
                                <button class="checkuotBtn" type="button" onclick="controller.open('MainMenu');" style="background-color:#a6a06f;width:50%;"> &lt; חזרה</button>

                            </div>



                        </center>



                    
                    </form>
                </div>
            </div>
        </div>
    </section>


    db.Close();
}